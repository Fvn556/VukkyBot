<!DOCTYPE html>
<html class="home bg-gray-800">
	<head>
		<title>VukkyBot Dashboard</title>
		<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"> </script>
		<link rel="stylesheet" href="tailwind.css">
	</head>
	<body>
		<div class="bg-gray-900 w-60 rounded-full h-20 m-8">
			<img id="avatar" class="rounded-full align-middle h-20">
			<p class="float-right text-white align-middle">test</p>
		</div>
		<h1 id="loggedIn" class="text-3xl font-bold text-white">Loading...</h1>  
	</body>
	<script>
		function getQueryVariable(variable) {
			var query = window.location.search.substring(1);
			var vars = query.split("&");
			for (var i=0;i<vars.length;i++) {
				var pair = vars[i].split("=");
				if(pair[0] == variable){return pair[1];}
			}
			return(false);
		}

		function setCookie(cname, cvalue, exdays) {
			var d = new Date();
			d.setTime(d.getTime() + (exdays*24*60*60*1000));
			var expires = "expires="+ d.toUTCString();
			document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
		}

		function getCookie(cname) {
			var name = cname + "=";
			var decodedCookie = decodeURIComponent(document.cookie);
			var ca = decodedCookie.split(';');
			for(var i = 0; i <ca.length; i++) {
				var c = ca[i];
				while (c.charAt(0) == ' ') {
					c = c.substring(1);
				}
				if (c.indexOf(name) == 0) {
				return c.substring(name.length, c.length);
				}
			}
			return "";
		}

		setCookie("sessionId", getQueryVariable("code"), 1);
		var user
		let url = "/gimmedata"
		let data = { code:getCookie("sessionId") }
		$.post(url,data, (data, status) => {
			let info = JSON.parse(data);
			fetch("https://discord.com/api/users/@me", {
						headers: {
							authorization: `${info.token_type} ${info.access_token}`,
						},
					})
					.then(userRes => userRes.json())
					.then(userRes => {
						user = userRes;
						live()
					});
		})
		function live() {
			console.log(user)
			document.getElementById("loggedIn").innerHTML = `Hi, ${user.username}#${user.discriminator}!` 
			document.getElementById("avatar").src = `https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png?size=128`
		}
	</script>
</html>
