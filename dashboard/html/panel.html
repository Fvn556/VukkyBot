<!DOCTYPE html>
<html class="home bg-gray-800 text-white">
	<head>
		<title>VukkyBot Dashboard</title>
		<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"> </script>
		<link rel="stylesheet" href="tailwind.css">
	</head>
	<body>
		<div class="table-row-group">
		<div class="bg-gray-900 w-64 rounded-full h-20 m-8 flex whitespace-pre-line">
			<img id="avatar" class="rounded-full align-middle h-20">
			<p class="text-white align-middle m-auto" id="username">Loading...</p>
			<p class="text-white align-middle m-auto" id="userid">Loading...</p>
		</div>
		<div class="inline float-right">
			<button class="button button-blue text-2xl font-bold inline float-right px-10 m-10">Save Changes</button>
			<button class="button button-blue text-2xl font-bold inline float-right px-10 m-10" onclick="logOut()">Log out</button>
		</div>
	</div>
		<h1 id="loggedIn" class="text-3xl font-bold text-white">Loading...</h1>  
		<div class="w-full flex flex-wrap whitespace-pre-line" id="options">
		
			
		</div>
	</body>
	<script>

		class intConfig {
			constructor(currentValue, configName) {
				this.currentValue = currentValue;
				this.configName = configName;
				document.getElementById("options").innerHTML += `<div class=" m-5 bg-gray-900 w-80 rounded-full h-20 whitespace-pre-line"><p>${configName}</p><br/><input type="number" id="${configName}" class="text-black" value="${currentValue}" onchange="updateCfg('${configName}')"></input></div>`
			}
		}
		class stringConfig {
			constructor(currentValue, configName) {
				this.currentValue = currentValue;
				this.configName = configName;
				document.getElementById("options").innerHTML += `<div class=" m-5 bg-gray-900 w-80 rounded-full h-20 whitespace-pre-line"><p>${configName}</p><br/><input type="text" id="${configName}" class="text-black" value="${currentValue}" onchange="updateCfg('${configName}')"></input></div>`
			}
		}
		class booleanConfig {
			constructor(currentValue, configName) {
				this.currentValue = currentValue;
				this.configName = configName;
				if(currentValue) {
					document.getElementById("options").innerHTML += `<div class=" m-5 bg-gray-900 w-80 rounded-full h-20 whitespace-pre-line"><p>${configName}</p><br/><input type="checkbox" id="${configName}" class="text-black w-5 h-5" checked onchange="updateCfgBool('${configName}')"></input></div>`
				} else {
					document.getElementById("options").innerHTML += `<div class=" m-5 bg-gray-900 w-80 rounded-full h-20 whitespace-pre-line"><p>${configName}</p><br/><input type="checkbox" id="${configName}" class="text-black w-5 h-5" onchange="updateCfgBool('${configName}')"></input></div>`
				}
			}
		}

		function updateCfg(updated) {
		let url = "/set"
		let data = { code:getCookie("sessionId"), option:updated, value:document.getElementById(updated).value}
		$.post(url,data, (data, status) => {
			console.log(data)
			if (data == "403") window.location = window.location;
		})
		}
		
		function updateCfgBool(updated) {
			let url = "/set"
		let data = { code:getCookie("sessionId"), option:updated, value:document.getElementById(updated).checked}
		$.post(url,data, (data, status) => {
			console.log(data)
			if (data == "403") window.location = window.location;
		})
		}

		function getQueryVariable(variable) {
			var query = window.location.search.substring(1);
			var vars = query.split("&");
			for (var i=0;i<vars.length;i++) {
				var pair = vars[i].split("=");
				if(pair[0] == variable){return pair[1];}
			}
			return(false);
		}

		function setCookie(cname, cvalue, exdays) {
			var d = new Date();
			d.setTime(d.getTime() + (exdays*24*60*60*1000));
			var expires = "expires="+ d.toUTCString();
			document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
		}

		function getCookie(cname) {
			var name = cname + "=";
			var decodedCookie = decodeURIComponent(document.cookie);
			var ca = decodedCookie.split(';');
			for(var i = 0; i <ca.length; i++) {
				var c = ca[i];
				while (c.charAt(0) == ' ') {
					c = c.substring(1);
				}
				if (c.indexOf(name) == 0) {
				return c.substring(name.length, c.length);
				}
			}
			return "";
		}

		setCookie("sessionId", getQueryVariable("code"), 1);
		var user
		let url = "/gimmedata"
		let data = { code:getCookie("sessionId") }
		$.post(url,data, (data, status) => {
			let info = JSON.parse(data).info;
			fetch("https://discord.com/api/users/@me", {
						headers: {
							authorization: `${info.token_type} ${info.access_token}`,
						},
					})
					.then(userRes => userRes.json())
					.then(userRes => {
						user = userRes;
						live()
					});
		})
		function logOut() {
			let url = "/logout"
			let data = { code:getCookie("sessionId") }
			$.post(url,data, (data, status) => {
			console.log(data);
			window.location = window.location;
			});
		}
		let url2 = "/cfg"
		let data2 = {code:"template"}
		var cfgtemplate = {};
		var allOptions = []
		$.post(url2,data2, (data, status) => {
			cfgtemplate = JSON.parse(data)
		}).then(function() {
			
			for(key in cfgtemplate) {
				let keyx = cfgtemplate[key]
				if (typeof keyx == "object") {
					for (keyxy in keyx) {
						let keyxyx = cfgtemplate[key][keyxy]
						if(typeof keyxyx == "object" && keyxy != "owner") {
							for (keyxyxy in keyxyx) {
								allOptions.push(key + "." + keyxy + "." + keyxyxy)
							}
						} else {
							allOptions.push(key + "." + keyxy);
						}
						
					}
				} else {
					allOptions.push(key);
				}
			}
			console.log(allOptions)
		})
		function live() {
			if(user.premium_type == 2) {
				document.getElementById("username").innerHTML = `${user.username}#${user.discriminator}\n${user.id}<img id="nitroBadge" src="https://discord.com/assets/386884eecd36164487505ddfbac35a9d.svg" class="">`
			} else {
				if(user.premium_type == 1) {
					document.getElementById("username").innerHTML = `${user.username}#${user.discriminator}\n${user.id}\nNitro Classic`
				} else {

					document.getElementById("username").innerHTML = `${user.username}#${user.discriminator}\n${user.id}`
				}
			}


			document.getElementById("userid").innerHTML = `` //future proofing with the string and not just variable lol (lazy) 
			document.getElementById("loggedIn").innerHTML = `Hi, ${user.username}#${user.discriminator}!` 
			document.getElementById("avatar").src = `https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png?size=128`
			for (let key in allOptions) {
				//console.log("key: " + allOptions[key]);
				$.post("/get",`code=${getCookie("sessionId")}=${allOptions[key]}`, (data, status) => {
					//let info = JSON.parse(data);
					console.log(allOptions[key] + ":" + data);
					if(allOptions[key] != "misc.owner") {
						if(!isNaN(parseInt(data))) {
							new intConfig(data, allOptions[key])
						} else {
							if (typeof data == "string") {
								if (data == "true" || data == "false") {
									console.log(data)
									new booleanConfig((data == "true"), allOptions[key])
								} else {

									new stringConfig(data, allOptions[key])
								}
							} else {
								if (typeof data == "boolean") {
									new booleanConfig(data, allOptions[key])
								}
							}
						}
					}
				})
			}
			//new stringConfig("pp", "counting.channelName");
			new booleanConfig(false, "pisssssssssssssssssss");
		}
	</script>
</html>
